name: ë¸Œëœì¹˜ ìµœì‹  ìƒíƒœ ê²€ì‚¬

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_target:
    types: [closed]

jobs:
  check-up-to-date:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: PR Mergeì‹œ Open PRì— ìµœì‹ í™” ê²€ì‚¬ ì§„í–‰
        if: github.event.pull_request.merged == true
        id: get-prs
        run: |
          base_branch="${{ github.event.pull_request.base.ref }}"

          gh api graphql -f query='
            query {
              repository(owner: "${{ github.repository_owner }}", name: "${{ github.event.repository.name }}") {
                pullRequests(states: OPEN, first: 100) {
                  nodes {
                    number
                    headRefName
                    baseRefName
                  }
                }
              }
            }
          ' -q '.data.repository.pullRequests.nodes' | jq -c '.[]' | while read -r pr; do
            pr_number=$(echo "$pr" | jq -r '.number')
            pr_base_branch=$(echo "$pr" | jq -r '.baseRefName')
            
            if [ "$pr_base_branch" = "$base_branch" ] && [ "$pr_number" != "${{ github.event.pull_request.number }}" ]; then
              echo "ğŸ”„ PR #${pr_number} ì¬ì‹¤í–‰ íŠ¸ë¦¬ê±°"
              gh workflow run check-up-to-date.yml -r $(gh pr view $pr_number --json headRefName -q .headRefName)
            fi
          done
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: ë¸Œëœì¹˜ ìµœì‹  ìƒíƒœ í™•ì¸
        if: github.event.pull_request.merged != true
        run: |
          base_branch="${{ github.base_ref }}"
          git fetch origin ${base_branch}

          if ! git merge-base --is-ancestor origin/${base_branch} HEAD; then
            echo "âŒ í˜„ì¬ ë¸Œëœì¹˜ê°€ ${base_branch}ì˜ ìµœì‹  ì»¤ë°‹ì„ í¬í•¨í•˜ê³  ìˆì§€ ì•ŠìŠµë‹ˆë‹¤."
            echo "ë¦¬ë² ì´ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
